<<<
[[Requirements]]
== Requirements

=== UC.XX - Requirements Start / Stop transaction +

Functional block: B. Transactions +

[width="100%", cols="^1,^1,2,^1,3,^1,2,2",options="noheader"]
|=======================================================================
| *CH*  | *FR/NF/C* | *Pre-condition*                                                                 | *ID* | *Requirement definition*                                                                                                                                                          | *M/O/C* | *Rationale* | *Note*
| 3.3 | C       | if the presented idTag is the same as the idTag presented to start the transaction. |    | A Charge Point MUST NOT send an Authorize.req before stopping a transaction.             | N     |           |
| 3.3 | FR      | When started charging.                                                              |    | The user shall be authenticated first before charging can be started.                    | M     |           |
| 3.3 | FR      |                                                                                     |    | The Charge Point shall inform the Central System that it has started with charging.      | M     |           |
| 3.3 | FR      | When unplugging                                                                     |    | The Charge Point shall verify the user and/or user-group in order to terminate charging. | M     |           |
| 3.4.3 | FR | Both Authorization Cache and Local Authorization List are supported |   | The Charge Point shall treat Local Authorization List entries as having priority over Authorization Cache entries for the same identifiers. | M | |
| 3.4.4 |	FR	| If offline.	| | The Charge Point shall allow automatic authorization of any "unknown" identifiers that cannot be explicitly authorized by Local Authorization List or Authorization Cache entries. Identifiers that are present in a Local Authorization List that have a status other than “Accepted”.|	M | |
| 3.4.4	| FR	| If offline. | | The Charge Point shall allow automatic authorization of any "unknown" identifiers that cannot be explicitly authorized by Authorization Cache entries.	| M |  |
| 3.4.4	| FR |	If offline. | |	Identifiers that are present in a Local Authorization List that have a status other than “Accepted” (Invalid, Blocked, Expired) shall be rejected.| 	M |  |
| 3.4.4 |	FR |	If offline. | | Identifiers that were valid but are apparently expired due to passage of time shall also be rejected.|	M |  |
| 3.4.4 |	FR |	Unknown Offline Authorization capability is supported. |	|	The Charge Point shall report operation of the Unknown Offline Authorization capability the AllowOfflineTxForUnknownId  configuration key.|	M|  |
| 3.4.4 |	FR |	Unknown Offline Authorization capability is supported. | |	The Charge Point shall control operation of the Unknown Offline Authorization capability the AllowOfflineTxForUnknownId configuration key.|	M| |
| 3.4.4 |	FR |	The connection to the Central Server is restored.	| FR.XXX	| The Charge point shall send  a Start Transaction request for any transaction that was authorized offline, as required by transaction-related message handling. |	M |  |
| 3.4.4 |	FR |	When the authorization status in the <<StartTransaction.conf, StartTransaction.conf>> is not Accepted and the transaction is still ongoing. And when StopTransactionOnInvalidId is set to true.|	 |	The Charge Point shall stop the transaction normally as stated in Stop Transaction |	C | |
| 3.4.4 | FR | When the authorization status in the <<StartTransaction.conf, StartTransaction.conf>> is not Accepted and the transaction is still ongoing. And when StopTransactionOnInvalidId is set to true. |   | The Charge Point shall stop the transaction normally as stated in Stop Transaction | C | |
| 3.4.4 | FR |                                                                    |   | The Reason field in the Stop Transaction request shall be set to DeAuthorized.                                                                    | M |   |
| 3.4.4 | FR | If the Charge Point has the possibility to lock the Charge Cable. |   | The Charge Point shall keep the Charging Cable locked until the owner presents his identifier.                                                    | M |   |
| 3.4.4 | FR | If StopTransactionOnInvalidId is set to false.                     |   | The Charge Point shall only stop energy delivery to the vehicle.                                                                                  | M |   |
| 3.4.4 | FR | Invalid identifier                                                 |   | The operator shall choose to the charge the EV minimum amount of energy so the EV is able to drive away.                                          | M |   |
| 3.5   | FR |                                                                    |   | There shall be multiple energy transfer periods during a transaction.                                                                              | O |   |
| 3.5   | FR |                                                                    |   | Multiple Energy Transfer Periods shall be separated by an EVSE-initiated suspense of transfer during which de EVSE does not offer energy transfer. | O |   |
| 3.5 | FR |                                                                                                 |   | Multiple Energy Transfer Periods shall be separated by an EV-initiated suspense of transfer during which the EV remains electrically connected to the EVSE . | O |   |
| 3.5 | FR |                                                                                                 |   | Multiple Energy Transfer Periods shall be separated by an EV-initiated suspense of transfer during which the EV is not electrically connected to the EVSE.   | O |   |
| 3.5 | FR |                                                                                                 |   | The Central System shall deduce the start and end of an Energy Transfer Period from the MeterValues that are sent during the Transaction.                    | O |   |
| 3.6 | FR |                                                                                                 |   | The Charge Point shall deliver transaction-related messages to the Central System in chronological order as soon as possible.                                | M |   |
| 3.6 | FR | If offline.                                                                                     |   | The Charge Point shall queue any transaction-related messages that it would have sent to the Central System if the Charge Point had been online.             | M |   |
| 3.6 | FR | When the Charge Point has transaction-related messages queued to be sent to the Central System. |   | The Charge Point shall deliver new messages that are not transaction-related immmeadeattely without wating for the que to be emptied.                        | O |   |
| 3.6    | FR |                                                                                                                                                                                                                                                                                    |   | The delivery of new transaction-related messages shall wait until the queue has been emptied.                                                                                                           | M | This is to ensure that transaction-related messages are always delivered in chronological order. |
| 3.6    | FR | When the Central System receives a transaction-related message that was queued on the Charge Point for some time, the Central System will not be aware that this is a historical message, other than by inference given that the various timestamps are significantly in the past. |   | The Central System shall process the transaction-related message as any other.                                                                                                                          | C |                                                                                                  |
| 3.6.1  | FR | If and only if the Central System repeatedly reports a `failure to process the message'.                                                                                                                                                                                           |   | The Charge Point shall be able to skip a transaction-related message.                                                                                                                                   | M |                                                                                                  |
| 3.6.1  | FR | The TransactionMessageAttempts and TransactionMessageRetryInterval configuration keys are configured.                                                                                                                                                                              |   | The number of times and the interval with which the Charge Point should retry such failed transaction-related messages shall be configured using the TransactionMessageAttempts configruation key.      | M |                                                                                                  |
| 3.6.1  | FR |                                                                                                                                                                                                                                                                                    |   | The number of times and the interval with which the Charge Point should retry such failed transaction-related messages shall be configured using the TransactionMessageRetryInterval configuration key. | M |                                                                                                  |
| 3.6.1  | FR | When a first failure to deliver a certain transaction-related message. And it has not yet encountered as many failures to process the message for this message as specified in its TransactionMessageAttempts configuration key.                                                   |   | The Charge Point shall send this message again as long as it keeps resulting in a failure to process the message.                                                                                       | C |                                                                                                  |
| 3.6.1  | FR | Before every retransmission                                                                                                                                                                                                                                                        |   | The Charge Point shall wait as many seconds as specified in its TransactionMessageRetryInterval key, multiplied by the number of preceding transmissions of this same message.                          | M |                                                                                                  |
| 3.7    | FR | For operations initiated by the Central System.                                                                                                                                                                                                                                     |   | The connectorId 0 shall be reserved for addressing the entire Charge Point.                                                                                                                             | M |                                                                                                 |
| 3.12.1 | FR | In load balancing scenarios.           |   | The Charge Point shall have one or more local charging profiles that limit the power or current to be shared by all connectors of the Charge Point.                                                     | M |    |
| 3.12.1 | FR | In load balancing scenarios.                              |   | The Central System shall configure such a profile with ChargingProfilePurpose set to “ChargePointMaxProfile”. ChargePointMaxProfile can only be set at Charge Point ConnectorId 0.                      | M |      |
| 3.12.1 | FR | Schedule prevents charging during the day.                                                                                   |   | ChargingProfilePurpose shal be set to TxDefaultProfile.                                                                                                            | M |                                                                                                                         |
| 3.12.1 | FR | If TxDefaultProfile is set to ConnectorId 0                                                                                  |   | The TxDefaultProfile shall be applicable to all Connectors.                                                                                                        | M |                                                                                                                         |
| 3.12.1 | FR | If ConnectorId is set >0,                                                                                                    |   | The TxDefaultProfile shall applicable to that specific connector.                                                                                                  | M |                                                                                                                         |
| 3.12.1 | FR | In the event a TxDefaultProfile for connector 0 is installed. and the Central System sends a new profile with ConnectorId >0 |   | The TxDefaultProfile shall be replaced only for that specific connector.                                                                                           | M |                                                                                                                         |
| 3.12.1 | FR | If a transaction-specific profile with purpose TxProfile is present                                                          |   | The transaction-specific shall  overrule the default charging profile .                                                                                            | M |                                                                                                                         |
| 3.12.1 | FR | If and after the transaction is stopped.                                                                                     |   | The transaction-specific shall be deleted.                                                                                                                         | M |                                                                                                                         |
| 3.12.1 | FR | If there is no transaction active on the connector specified in a charging profile of type TxProfile                         |   | The Charge Point shall discard it and return an error status in SetChargingProfile.conf.                                                                           | M |                                                                                                                         |
| 3.12.1 | FR | If in case no profile of purpose TxProfile is provided.                                                                      |   | TxProfile SHALL only be set at Charge Point ConnectorId >0.                                                                                                        | M |                                                                                                                         |
| 3.12.2 | FR | Whenever a Charge Point receives a Charging Profile with a stackLevel and Purpose that already exists in the Charge Point    |   | The new Charge Point shall replace the Charging Profile existing profile.                                                                                          | M |                                                                                                                         |
| 3.12.3 | FR | At any point in time                                                                                                         |   | The available power or current in the Composite Schedule SHALL be less than or equal to lowest value of available power or current in any of the merged schedules. | M |                                                                                                                         |
| 3.12.3 | FR | Charge Point has >1 connector                                                                                                |   | The Charge Point limit value of  ChargePointMaxProfile  shall be the limit for all connectors combined.                                                            | M |                                                                                                                         |
| 3.12.4 | FR | When central smart charging.                                                                                                 |   | The Central System shall determine the constraints on the charging schedule per transaction.                                                                       | O |                                                                                                                         |
| 3.12.4 | FR | In analogy to the Local Smart Charging use case                                                                              |   | A Charge Point connector shall execute a charging schedule by the Control Pilot signal.                                                                            | O |                                                                                                                         |
| 3.12.4 | FR | After authorization                                                                                                          |   | The connector shall set a maximum current to use via the Control Pilot signal.                                                                                     | O | This limit is based on a (default) charging profile that the connector had previously received from the Central System. |
| 3.12.4 | FR | When charging                                                                                                                |   | The connector shall continuously adapt the maximum current or power according to the charging profile.                                                             | O |                                                                                                                         |
| 3.12.4 | FR | A Smart Charging enabled Charge Point.                                                                                       |   | The Charge Point shall implement, and support reporting of the ChargeProfileMaxStackLevel configuration key through the GetConfiguration.req PDU.                  | O |                                                                                                                         |
|=======================================================================

=== UC.XX - Requirements 4 +

[width="100%", cols="^1,^1,2,^1,3,^1,2,2",options="noheader"]
|=======================================================================
| *CH*  | *FR/NF/C* | *Pre-condition*                                                                 | *ID* | *Requirement definition*                                                                                                                                                          | *M/O/C* | *Rationale* | *Note*
| 4.8  | FR |                                                                                                                                                                                                                                              |   | The Charge Point shall send a <<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> PDU to the Central System.                                                                           | M | To inform about a transaction that has been started.                                                      |
| 4.8  | FR | If this transaction ends a reservation (see Reserve Now operation).                                                                                                                                                                          |   | The <<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> shall contain the reservationId.                                                                                               | M |                                                                                                           |
| 4.8  | FR | Upon receipt of a <<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> PDU.                                                                                                                                                                                                  |   | The Central System SHOULD respond with a <<StartTransaction.conf, StartTransaction.conf>> PDU. This response PDU shall include a transaction id and an authorization status value. | M |                                                                                                           |
| 4.8  | FR |                                                                                                                                                                                                                                              |   | The Central System shall verify validity of the identifier in the <<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> PDU.                                                             | M | Because the identifier might have been authorized locally by the Charge Point using outdated information. |
| 4.8  | FR | If Charge Point has implemented an Authorization Cache, upon receipt of a <<StartTransaction.conf, StartTransaction.conf>> PDU. if the idTag is not in the Local Authorization List, with the IdTagInfo value from the response as described under Authorization Cache. |   | The Charge Point shall update the cache entry.                                                                                                          | M |                                                                                                           |
| 4.8  | FR |                                                                                                                                                                                                                                              |   | The Central System shall apply sanity checks to the data contained in a <<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> it received.                                               | M |                                                                                                           |
| 4.10 | FR | When a transaction is stopped.                                                                                                                                                                                                               |   | The Charge Point shall send a StopTransaction.req PDU, notifying to the Central System that the transaction has stopped.                                | M |                                                                                                           |
| 4.10 | FR |                                                                                                                                                                                                                                              |   | A StopTransaction.req PDU shall contain an optional TransactionData element to provide more details about transaction usage                             | O |                                                                                                           |
| 4.10 | FR | Upon receipt of a StopTransaction.req PDU.                                                                                                                                                                                                   |   | The Central System shall respond with a StopTransaction.conf PDU.                                                                                       |   |                                                                                                           |
| 4.10 | FR |                                                                                                                                                                                                                                              |   | The Central System shall apply sanity checks to the data contained in a StopTransaction.req it received.                                                | M |                                                                                                           |
| 4.10 | C  |                                                                                                                                                                                                                                              |   | The outcome of such sanity checks SHOULD NOT ever cause the Central System to not respond with a StopTransaction.conf.                                  | N |                                                                                                           |
|=======================================================================


=== UC.XX - Requirements 5 +

[width="100%", cols="^1,^1,2,^1,3,^1,2,2",options="noheader"]
|=======================================================================
| *CH*  | *FR/NF/C* | *Pre-condition*                                                                 | *ID* | *Requirement definition*                                                                                                                                                          | *M/O/C* | *Rationale* | *Note*
| 5.11 | FR      |                                                                                           |    | The Central System can request a Charge Point to start a transaction by sending a Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>>.                                                                                       | C     | To start a transaction. |
| 5.11 | FR      | Upon receipt                                                                              |    | The Charge Point shall reply with Remote<<StartTransaction.conf, StartTransaction.conf>> and a status indicating whether it is able to start a transaction or not.                                                             | M     |                         |
| 5.11 | FR      |                                                                                           |    | The effect of the Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> message shall depend on the value of the AuthorizeRemoteTxRequests configuration key in the Charge Point.                                              | M     |                         |
| 5.11 | FR      | If the value of AuthorizeRemoteTxRequests is true.                                        |    | The Charge Point shall behave as if in response to a local action at the Charge Point to start a transaction with the idTag given in the Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> message.                        | M     |                         | This means that the Charge Point will first try to authorize the idTag, using the Local Authorization List, Authorization Cache and/or an Authorize.req request. A transaction will only be started after authorization was obtained.
| 5.11 | FR      | If the value of AuthorizeRemoteTxRequests is false.                                       |    | The  Charge Point shall immediately try to start a transaction for the idTag given in the Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> message.                                                                       | M     |                         | Note that after the transaction has been started, the Charge Point will send a StartTransaction request to the Central System, and the Central System will check the authorization status of the idTag when processing this StartTransaction request.
| 5.11 | FR      | After the transaction has been started.                                                   |    | The Charge Point will send a StartTransaction request to the Central System, and the Central System will check the authorization status of the idTag when processing this StartTransaction request. |       |                         |
| 5.11 | FR      |                                                                                           |    | The Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> shall contain an identifier (idTag), which Charge Point shall use, if it is able to start a transaction, to send a <<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> to Central System.           | M     |                         |
| 5.11 | FR      |                                                                                           |    | The transaction shall be started in the same way as described in StartTransaction.                                                                                                                  | M     |                         |
| 5.11 | FR      |                                                                                           |    | The Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> MAY contain a connector id if the transaction is to be started on a specific connector.                                                                              | O     |                         | When no connector id is provided, the Charge Point is in control of the connector selection
| 5.11 | FR      | Without a connector id.                                                                   |    | The Charge Point MAY reject a Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>>.                                                                                                                                           | O     |                         |
| 5.11 | FR      |                                                                                           |    | The Central System MAY include a ChargingProfile in the RemoteStartTransaction request                                                                                                              | O     |                         |
| 5.11 | FR      | previous requirement                                                                      |    | The purpose of this ChargingProfile shall be set to TxProfile.                                                                                                                                      | M     |                         |
| 5.11 | FR      | If accepted.                                                                              |    | The Charge Point shall use this ChargingProfile for the transaction.                                                                                                                                | M     |                         |
| 5.11 | FR      | If a Charge Point without support for Smart Charging receives a RemoteStartTransaction.re |    | The Charge Point shall ignore Remote<<<<StartTransaction.req, StartTransaction.req>>, <<StartTransaction.req, StartTransaction.req>>>> with a Charging Profile.                                                                                                                   | C     |                         |
| 5.12 | FR      |                                                                                           |    | The Central System shall request a Charge Point to stop a transaction by sending a RemoteStopTransaction.req to Charge Point with the identifier of the transaction.                                | M     |                         |
| 5.12 | FR      | previous requirement                                                                      |    | The Charge Point shall reply with RemoteStopTransaction.conf to indicate whether it is indeed able to stop the transaction.                                                                         | M     |                         |
| 5.12 | FR      |                                                                                           |    | The remote request to stop a transaction shall be equal to a local action to stop a transaction.                                                                                                    | M     |                         |
| 5.12 | FR      |                                                                                           |    | The Charge Point shall send a StopTransaction.req and, if applicable, unlock the connector.                                                                                                         | M     |                         |
|=======================================================================

[[transaction-message-error-responses]]
==== Error responses to transaction-related messages

It is permissible for the Charge Point to skip a transaction-related message if
and only if the Central System repeatedly reports a `failure to process the
message'. Such a stipulation is necessary, because otherwise the requirement to
deliver every transaction-related message in chronological order would entail
that the Charge Point cannot deliver any transaction-related messages to the
Central System after a software bug causes the Central System not to
acknowledge one of the Charge Point's transaction-related messages.

What kind of response, or failure to respond, constitutes a `failure to process
the message' is defined in the documents <<ref-OCPP_IMP_J, OCPP JSON Specification>> and <<ref-OCPP_IMP_S, OCPP SOAP Specification>>.

The number of times and the interval with which the Charge Point should retry
such failed transaction-related messages MAY be configured using the
<<configkey-transaction-message-attempts,`TransactionMessageAttempts`>> and
<<configkey-transaction-message-retry-interval,`TransactionMessageRetryInterval`>>
configuration keys.

When the Charge Point encounters a first failure to deliver a certain
transaction-related message, it SHOULD send this message again as long as it
keeps resulting in a failure to process the message and it has not yet
encountered as many failures to process the message for this message as
specified in its <<configkey-transaction-message-attempts,`TransactionMessageAttempts`>>
configuration key. Before every
retransmission, it SHOULD wait as many seconds as specified in its
<<configkey-transaction-message-retry-interval,`TransactionMessageRetryInterval`>>
key, multiplied by the number of preceding
transmissions of this same message.

As an example, consider a Charge Point that has the value "3" for the
<<configkey-transaction-message-attempts,`TransactionMessageAttempts`>>
configuration key and the value "60" for the
<<configkey-transaction-message-retry-interval,`TransactionMessageRetryInterval`>>
configuration key. It sends a StopTransaction
message and detects a failure to process the message in the Central System.
The Charge Point SHALL wait for 60 seconds, and resend the message.
In the case when there is a second failure, the Charge Point SHALL wait for 120 seconds,
before resending the message.
If this final attempt fails, the Charge Point SHOULD discard the message
and continue with the next transaction-related message, if there is any.
